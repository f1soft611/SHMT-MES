<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SchedulerHistoryDAO">

    <!-- 스케쥴러 실행 이력 resultMap -->
    <resultMap id="schedulerHistoryResultMap" type="egovframework.let.scheduler.domain.model.SchedulerHistory">
        <result property="historyId" column="history_id"/>
        <result property="schedulerId" column="scheduler_id"/>
        <result property="schedulerName" column="scheduler_name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="status" column="status"/>
        <result property="errorMessage" column="error_message"/>
        <result property="executionTimeMs" column="execution_time_ms"/>
        <result property="regDt" column="reg_dt"/>
    </resultMap>

    <resultMap id="schedulerHistoryVOResultMap" type="egovframework.let.scheduler.domain.model.SchedulerHistoryVO">
        <result property="historyId" column="history_id"/>
        <result property="schedulerId" column="scheduler_id"/>
        <result property="schedulerName" column="scheduler_name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="status" column="status"/>
        <result property="errorMessage" column="error_message"/>
        <result property="executionTimeMs" column="execution_time_ms"/>
        <result property="regDt" column="reg_dt"/>
    </resultMap>

    <!-- 스케쥴러 실행 이력 목록 조회 -->
    <select id="SchedulerHistoryDAO.selectSchedulerHistoryList" resultMap="schedulerHistoryVOResultMap" 
            parameterType="egovframework.let.scheduler.domain.model.SchedulerHistoryVO">
        SELECT
            history_id,
            scheduler_id,
            scheduler_name,
            start_time,
            end_time,
            status,
            error_message,
            execution_time_ms,
            reg_dt
        FROM scheduler_history
        WHERE 1=1
        <if test="schedulerId != null">
            AND scheduler_id = #{schedulerId}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="searchWrd != null and searchWrd != ''">
            AND (scheduler_name LIKE '%' + #{searchWrd} + '%'
                 OR error_message LIKE '%' + #{searchWrd} + '%')
        </if>
        ORDER BY history_id DESC
        <if test="firstIndex != null and recordCountPerPage != null">
            OFFSET #{firstIndex} ROWS
            FETCH NEXT #{recordCountPerPage} ROWS ONLY
        </if>
    </select>

    <!-- 스케쥴러 실행 이력 총 개수 조회 -->
    <select id="SchedulerHistoryDAO.selectSchedulerHistoryListCnt" resultType="int" 
            parameterType="egovframework.let.scheduler.domain.model.SchedulerHistoryVO">
        SELECT COUNT(*)
        FROM scheduler_history
        WHERE 1=1
        <if test="schedulerId != null">
            AND scheduler_id = #{schedulerId}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="searchWrd != null and searchWrd != ''">
            AND (scheduler_name LIKE '%' + #{searchWrd} + '%'
                 OR error_message LIKE '%' + #{searchWrd} + '%')
        </if>
    </select>

    <!-- 스케쥴러 실행 이력 상세 조회 -->
    <select id="SchedulerHistoryDAO.selectSchedulerHistoryDetail" resultMap="schedulerHistoryResultMap" parameterType="long">
        SELECT
            history_id,
            scheduler_id,
            scheduler_name,
            start_time,
            end_time,
            status,
            error_message,
            execution_time_ms,
            reg_dt
        FROM scheduler_history
        WHERE history_id = #{historyId}
    </select>

    <!-- 스케쥴러 실행 이력 등록 -->
    <insert id="SchedulerHistoryDAO.insertSchedulerHistory" parameterType="egovframework.let.scheduler.domain.model.SchedulerHistory">
        <selectKey keyProperty="historyId" resultType="long" order="AFTER">
            SELECT IDENT_CURRENT('scheduler_history')
        </selectKey>
        INSERT INTO scheduler_history (
            scheduler_id,
            scheduler_name,
            start_time,
            end_time,
            status,
            error_message,
            execution_time_ms,
            reg_dt
        ) VALUES (
            #{schedulerId},
            #{schedulerName},
            #{startTime},
            #{endTime},
            #{status},
            #{errorMessage},
            #{executionTimeMs},
            GETDATE()
        )
    </insert>

    <!-- 스케쥴러 실행 이력 수정 -->
    <update id="SchedulerHistoryDAO.updateSchedulerHistory" parameterType="egovframework.let.scheduler.domain.model.SchedulerHistory">
        UPDATE scheduler_history
        SET end_time = #{endTime},
            status = #{status},
            error_message = #{errorMessage},
            execution_time_ms = #{executionTimeMs}
        WHERE history_id = #{historyId}
    </update>

</mapper>
