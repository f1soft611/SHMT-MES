<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mberManageDAO">
    <resultMap id="stplatMap" type="egovframework.let.uss.umt.service.StplatVO">
        <result property="useStplatId"         column="USE_STPLAT_ID" />
        <result property="useStplatCn"         column="USE_STPLAT_CN" />
        <result property="infoProvdAgeCn"      column="INFO_PROVD_AGRE_CN" />
    </resultMap>
    <resultMap id="userList" type="egovframework.let.uss.umt.service.MberManageVO">
        <result property="uniqId" column="uniqId" />
        <result property="orgnztId" column="orgnztId" />
        <result property="userTy" column="userTy" />
        <result property="mberId" column="userId" />
        <result property="mberNm" column="userNm" />
        <result property="mberEmailAdres" column="emailAdres" />
        <result property="areaNo" column="areaNo" />
        <result property="middleTelno" column="middleTelno" />
        <result property="endTelno" column="endTelno" />
        <result property="moblphonNo" column="moblphonNo" />
        <result property="groupId" column="groupId" />
        <result property="mberSttus" column="sttus" />
        <result property="sbscrbDe" column="sbscrbDe" />
    </resultMap>
    <select id="selectMberList" parameterType="userSearchVO" resultMap="userList">
        SELECT
        uniqId, orgnztId, userTy, userId, userNm, emailAdres, areaNo, middleTelno, endTelno, moblphonNo, groupId, sttus, sbscrbDe
        FROM (
        SELECT
        ESNTL_ID AS uniqId,
        ORGNZT_ID AS orgnztId,
        'USR01' AS userTy,
        EMPLYR_ID AS userId,
        USER_NM AS userNm,
        EMAIL_ADRES AS emailAdres,
        AREA_NO AS areaNo,
        HOUSE_MIDDLE_TELNO AS middleTelno,
        HOUSE_END_TELNO AS endTelno,
        MBTLNUM AS moblphonNo,
        GROUP_ID AS groupId,
        EMPLYR_STTUS_CODE AS sttus,
        CONVERT(VARCHAR, SBSCRB_DE, 120) AS sbscrbDe
        FROM MES_USER_INFO
        ) A
        WHERE 1=1
        <if test="sbscrbSttus != 0">
            AND sttus LIKE '%' + #{sbscrbSttus} + '%'
        </if>
        <if test="searchCondition == 0">
            AND (userId LIKE '%' + #{searchKeyword} + '%' OR userNm LIKE '%' + #{searchKeyword} + '%')
        </if>
        <if test="searchCondition == 1">
            AND userId LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchCondition == 2">
            AND userNm LIKE '%' + #{searchKeyword} + '%'
        </if>
        ORDER BY sbscrbDe DESC
        OFFSET #{firstIndex} ROWS
        FETCH NEXT #{recordCountPerPage} ROWS ONLY
    </select>

    <select id="selectMberListTotCnt" parameterType="userSearchVO" resultType="int">
        SELECT COUNT(1) AS totcnt
        FROM (
        SELECT
        ESNTL_ID AS uniqId,
        ORGNZT_ID AS orgnztId,
        'USR01' AS userTy,
        EMPLYR_ID AS userId,
        USER_NM AS userNm,
        EMAIL_ADRES AS emailAdres,
        AREA_NO AS areaNo,
        HOUSE_MIDDLE_TELNO AS middleTelno,
        HOUSE_END_TELNO AS endTelno,
        MBTLNUM AS moblphonNo,
        GROUP_ID AS groupId,
        EMPLYR_STTUS_CODE AS sttus,
        SBSCRB_DE AS sbscrbDe
        FROM MES_USER_INFO
        ) A
        WHERE 1=1
        <if test="sbscrbSttus != 0">
            AND sttus LIKE '%' + #{sbscrbSttus} + '%'
        </if>
        <if test="searchCondition == 0">
            AND userId LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchCondition == 1">
            AND userNm LIKE '%' + #{searchKeyword} + '%'
        </if>
    </select>

    <insert id="insertMber_S">
        INSERT INTO MES_USER_INFO
        (
            ESNTL_ID          ,
            ORGNZT_ID		  ,
            EMPLYR_ID         ,
            USER_NM          ,
            PASSWORD         ,
            PASSWORD_HINT    ,
            PASSWORD_CNSR    ,
            IHIDNUM          ,
            SEXDSTN_CODE     ,
            ZIP              ,
            HOUSE_ADRES            ,
            AREA_NO          ,
            EMPLYR_STTUS_CODE       ,
            DETAIL_ADRES     ,
            HOUSE_END_TELNO        ,
            MBTLNUM      ,
            GROUP_ID         ,
            FXNUM       ,
            EMAIL_ADRES ,
            HOUSE_MIDDLE_TELNO     ,
            SBSCRB_DE        )
        VALUES(
                  #{uniqId},
                  'ORGNZT_0000000000000',
                  #{mberId},
                  #{mberNm},
                  #{password},
                  #{passwordHint},
                  #{passwordCnsr},
                  #{ihidnum},
                  #{sexdstnCode},
                  #{zip},
                  #{adres},
                  #{areaNo},
                  #{mberSttus},
                  #{detailAdres},
                  #{endTelno},
                  #{moblphonNo},
                  #{groupId},
                  #{mberFxnum},
                  #{mberEmailAdres},
                  #{middleTelno},
                  GETDATE()  )
    </insert>

    <delete id="deleteMber_S">
        DELETE FROM MES_USER_INFO
        WHERE ESNTL_ID=#{delId}
    </delete>

    <select id="selectMber_S" resultType="mberVO">
        SELECT
            ESNTL_ID AS uniqId,
            ORGNZT_ID AS orgnztId,
            'USR01' AS userTy,
            EMPLYR_ID AS mberId,
            USER_NM AS mberNm,
            PASSWORD AS password,
            PASSWORD_HINT AS passwordHint,
            PASSWORD_CNSR AS passwordCnsr,
            IHIDNUM AS ihidnum,
            SEXDSTN_CODE AS sexdstnCode,
            ZIP AS zip,
            HOUSE_ADRES AS adres,
            AREA_NO AS areaNo,
            EMPLYR_STTUS_CODE AS mberSttus,
            DETAIL_ADRES AS detailAdres,
            HOUSE_END_TELNO AS endTelno,
            MBTLNUM AS moblphonNo,
            GROUP_ID AS groupId,
            FXNUM AS mberFxnum,
            EMAIL_ADRES AS mberEmailAdres,
            HOUSE_MIDDLE_TELNO AS middleTelno,
            SBSCRB_DE AS sbscrbDe
        FROM MES_USER_INFO
        WHERE ESNTL_ID=#{uniqId}
    </select>

    <update id="updateMber_S">
        UPDATE MES_USER_INFO
        SET EMPLYR_ID          = #{mberId},
            USER_NM          = #{mberNm},
            PASSWORD_HINT    = #{passwordHint},
            PASSWORD_CNSR    = #{passwordCnsr},
            IHIDNUM          = #{ihidnum},
            SEXDSTN_CODE     = #{sexdstnCode},
            ZIP              = #{zip},
            HOUSE_ADRES      = #{adres},
            AREA_NO          = #{areaNo},
            EMPLYR_STTUS_CODE= #{mberSttus},
            DETAIL_ADRES     = #{detailAdres},
            HOUSE_END_TELNO  = #{endTelno},
            MBTLNUM          = #{moblphonNo},
            GROUP_ID         = #{groupId},
            FXNUM            = #{mberFxnum},
            EMAIL_ADRES      = #{mberEmailAdres},
            HOUSE_MIDDLE_TELNO = #{middleTelno}
        WHERE ESNTL_ID=#{uniqId}
    </update>

    <select id="selectStplat_S" resultMap="stplatMap">
        SELECT
            USE_STPLAT_ID,
            USE_STPLAT_CN,
            INFO_PROVD_AGRE_CN
        FROM LETTNSTPLATINFO
        WHERE USE_STPLAT_ID=#{stplatId}
    </select>

    <update id="updatePassword_S">
        UPDATE MES_USER_INFO
        SET
            PASSWORD   =  #{password}
        WHERE  ESNTL_ID  = #{uniqId}
    </update>

    <select id="selectPassword_S" resultType="mberVO">
        SELECT
            PASSWORD AS password
        FROM    MES_USER_INFO
        WHERE   ESNTL_ID=#{uniqId}
    </select>

    <select id="checkIdDplct_S" resultType="int">
        SELECT COUNT(1) AS usedCnt
        FROM(
                SELECT
                    EMPLYR_ID AS userId
                FROM    MES_USER_INFO
                UNION ALL
                SELECT
                    ENTRPRS_MBER_ID AS userId
                FROM    LETTNENTRPRSMBER
                UNION ALL
                SELECT
                    MBER_ID AS userId
                FROM    LETTNGNRLMBER
            ) A
        WHERE userId = #{checkId}
    </select>
</mapper>