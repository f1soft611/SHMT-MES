<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProductionPlanDAO">

	<resultMap id="productionPlanMasterResult" type="egovframework.let.production.plan.domain.model.ProductionPlanMaster">
		<result property="factoryCode" column="FACTORY_CODE"/>
		<result property="prodPlanDate" column="PRODPLAN_DATE"/>
		<result property="prodPlanSeq" column="PRODPLAN_SEQ"/>
		<result property="planDate" column="PLAN_DATE"/>
		<result property="opmanCode" column="OPMAN_CODE"/>
		<result property="optime" column="OPTIME"/>
		<result property="opmanCode2" column="OPMAN_CODE2"/>
		<result property="optime2" column="OPTIME2"/>
	</resultMap>

	<resultMap id="productionPlanResult" type="egovframework.let.production.plan.domain.model.ProductionPlan">
		<result property="factoryCode" column="FACTORY_CODE"/>
		<result property="prodPlanDate" column="PRODPLAN_DATE"/>
		<result property="prodPlanSeq" column="PRODPLAN_SEQ"/>
		<result property="planDate" column="PLAN_DATE"/>
		<result property="itemCode" column="ITEM_CODE"/>
		<result property="itemName" column="ITEM_NAME"/>
		<result property="plannedQty" column="PLANNED_QTY"/>
		<result property="actualQty" column="ACTUAL_QTY"/>
		<result property="equipmentCode" column="EQUIPMENT_CODE"/>
		<result property="equipmentName" column="EQUIPMENT_NAME"/>
		<result property="shift" column="SHIFT"/>
		<result property="workerCode" column="WORKER_CODE"/>
		<result property="workerName" column="WORKER_NAME"/>
		<result property="orderNo" column="ORDER_NO"/>
		<result property="orderSeqno" column="ORDER_SEQNO"/>
		<result property="orderHistno" column="ORDER_HISTNO"/>
		<result property="lotNo" column="LOT_NO"/>
		<result property="customerCode" column="CUSTOMER_CODE"/>
		<result property="customerName" column="CUSTOMER_NAME"/>
		<result property="remark" column="REMARK"/>
		<result property="useYn" column="USE_YN"/>
		<result property="opmanCode" column="OPMAN_CODE"/>
		<result property="optime" column="OPTIME"/>
		<result property="opmanCode2" column="OPMAN_CODE2"/>
		<result property="optime2" column="OPTIME2"/>
	</resultMap>

	<!-- 생산계획 마스터 등록 -->
	<insert id="ProductionPlanDAO.insertProductionPlanMaster" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanMaster">
		INSERT INTO TPR301M (
			FACTORY_CODE,
			PRODPLAN_DATE,
			PRODPLAN_SEQ,
			OPMAN_CODE,
			OPTIME
		) VALUES (
			#{factoryCode},
			#{planNo},
			#{planDate},
			#{opmanCode},
			GETDATE()
		)
	</insert>

	<!-- 생산계획 상세 등록 -->
	<insert id="ProductionPlanDAO.insertProductionPlan" parameterType="egovframework.let.production.plan.domain.model.ProductionPlan">
		INSERT INTO TPR301 (
			FACTORY_CODE,
			PLAN_NO,
			PLAN_SEQ,
			PLAN_DATE,
			ITEM_CODE,
			ITEM_NAME,
			PLANNED_QTY,
			ACTUAL_QTY,
			EQUIPMENT_CODE,
			EQUIPMENT_NAME,
			SHIFT,
			WORKER_CODE,
			WORKER_NAME,
			ORDER_NO,
			ORDER_SEQNO,
			ORDER_HISTNO,
			LOT_NO,
			CUSTOMER_CODE,
			CUSTOMER_NAME,
			REMARK,
			USE_YN,
			OPMAN_CODE,
			OPTIME
		) VALUES (
			#{factoryCode},
			#{planNo},
			#{planSeq},
			#{planDate},
			#{itemCode},
			#{itemName},
			#{plannedQty},
			ISNULL(#{actualQty}, 0),
			#{equipmentCode},
			#{equipmentName},
			#{shift},
			#{workerCode},
			#{workerName},
			#{orderNo},
			#{orderSeqno},
			#{orderHistno},
			#{lotNo},
			#{customerCode},
			#{customerName},
			#{remark},
			ISNULL(#{useYn}, 'Y'),
			#{opmanCode},
			GETDATE()
		)
	</insert>

	<!-- 생산계획 마스터 목록 조회 -->
	<select id="ProductionPlanDAO.selectProductionPlanMasterList" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanVO" resultMap="productionPlanMasterResult">
		SELECT
			FACTORY_CODE,
			PRODPLAN_DATE,
			PRODPLAN_SEQ,
			PRODPLAN_DATE AS PLAN_DATE,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TPR301M
		WHERE FACTORY_CODE = #{factoryCode}
		<if test="startDate != null and startDate != ''">
			AND PRODPLAN_DATE &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND PRODPLAN_DATE &lt;= #{endDate}
		</if>
		ORDER BY PRODPLAN_DATE DESC, PRODPLAN_SEQ ASC
	</select>

	<!-- 생산계획 상세 목록 조회 -->
	<select id="ProductionPlanDAO.selectProductionPlanList" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanVO" resultMap="productionPlanResult">
		SELECT
			FACTORY_CODE,
			PLAN_NO,
			PLAN_SEQ,
			PLAN_DATE,
			ITEM_CODE,
			ITEM_NAME,
			PLANNED_QTY,
			ACTUAL_QTY,
			EQUIPMENT_CODE,
			EQUIPMENT_NAME,
			SHIFT,
			WORKER_CODE,
			WORKER_NAME,
			ORDER_NO,
			ORDER_SEQNO,
			ORDER_HISTNO,
			LOT_NO,
			CUSTOMER_CODE,
			CUSTOMER_NAME,
			REMARK,
			USE_YN,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TPR301
		WHERE FACTORY_CODE = #{factoryCode}
		  AND USE_YN = 'Y'
		<if test="planNo != null and planNo != ''">
			AND PLAN_NO = #{planNo}
		</if>
		<if test="startDate != null and startDate != ''">
			AND PLAN_DATE &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND PLAN_DATE &lt;= #{endDate}
		</if>
		<if test="itemCode != null and itemCode != ''">
			AND ITEM_CODE = #{itemCode}
		</if>
		<if test="equipmentCode != null and equipmentCode != ''">
			AND EQUIPMENT_CODE = #{equipmentCode}
		</if>
		ORDER BY PLAN_DATE DESC, PLAN_NO DESC, PLAN_SEQ ASC
	</select>

	<!-- 생산계획 상세 조회 -->
	<select id="ProductionPlanDAO.selectProductionPlan" parameterType="egovframework.let.production.plan.domain.model.ProductionPlan" resultMap="productionPlanResult">
		SELECT
			FACTORY_CODE,
			PLAN_NO,
			PLAN_SEQ,
			PLAN_DATE,
			ITEM_CODE,
			ITEM_NAME,
			PLANNED_QTY,
			ACTUAL_QTY,
			EQUIPMENT_CODE,
			EQUIPMENT_NAME,
			SHIFT,
			WORKER_CODE,
			WORKER_NAME,
			ORDER_NO,
			ORDER_SEQNO,
			ORDER_HISTNO,
			LOT_NO,
			CUSTOMER_CODE,
			CUSTOMER_NAME,
			REMARK,
			USE_YN,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TPR301
		WHERE FACTORY_CODE = #{factoryCode}
		  AND PLAN_NO = #{planNo}
		  AND PLAN_SEQ = #{planSeq}
	</select>

	<!-- 생산계획 마스터 총 건수 조회 -->
	<select id="ProductionPlanDAO.selectProductionPlanMasterListTotCnt" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanVO" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR301M
		WHERE FACTORY_CODE = #{factoryCode}
		<if test="startDate != null and startDate != ''">
			AND PRODPLAN_DATE &gt;= #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND PRODPLAN_DATE &lt;= #{endDate}
		</if>
	</select>

	<!-- 계획번호로 생산계획 상세 목록 조회 -->
	<select id="ProductionPlanDAO.selectProductionPlanByPlanNo" parameterType="string" resultMap="productionPlanResult">
		SELECT
			FACTORY_CODE,
			PLAN_NO,
			PLAN_SEQ,
			PLAN_DATE,
			ITEM_CODE,
			ITEM_NAME,
			PLANNED_QTY,
			ACTUAL_QTY,
			EQUIPMENT_CODE,
			EQUIPMENT_NAME,
			SHIFT,
			WORKER_CODE,
			WORKER_NAME,
			ORDER_NO,
			ORDER_SEQNO,
			ORDER_HISTNO,
			LOT_NO,
			CUSTOMER_CODE,
			CUSTOMER_NAME,
			REMARK,
			USE_YN,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TPR301
		WHERE PLAN_NO = #{planNo}
		  AND USE_YN = 'Y'
		ORDER BY PLAN_SEQ ASC
	</select>

	<!-- 생산계획 마스터 수정 -->
	<update id="ProductionPlanDAO.updateProductionPlanMaster" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanMaster">
		UPDATE TPR301M
		SET
			PLAN_STATUS = #{planStatus},
			TOTAL_PLAN_QTY = #{totalPlanQty},
			REMARK = #{remark},
			OPMAN_CODE2 = #{opmanCode2},
			OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = #{factoryCode}
		  AND PLAN_NO = #{planNo}
	</update>

	<!-- 생산계획 상세 수정 -->
	<update id="ProductionPlanDAO.updateProductionPlan" parameterType="egovframework.let.production.plan.domain.model.ProductionPlan">
		UPDATE TPR301
		SET
			PLANNED_QTY = #{plannedQty},
			ACTUAL_QTY = #{actualQty},
			SHIFT = #{shift},
			WORKER_CODE = #{workerCode},
			WORKER_NAME = #{workerName},
			REMARK = #{remark},
			OPMAN_CODE2 = #{opmanCode2},
			OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = #{factoryCode}
		  AND PLAN_NO = #{planNo}
		  AND PLAN_SEQ = #{planSeq}
	</update>

	<!-- 생산계획 마스터 삭제 (논리적 삭제) -->
	<update id="ProductionPlanDAO.deleteProductionPlanMaster" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanMaster">
		UPDATE TPR301M
		SET
			USE_YN = 'N',
			OPMAN_CODE2 = #{opmanCode2},
			OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = #{factoryCode}
		  AND PLAN_NO = #{planNo}
	</update>

	<!-- 생산계획 상세 삭제 (논리적 삭제) -->
	<update id="ProductionPlanDAO.deleteProductionPlan" parameterType="egovframework.let.production.plan.domain.model.ProductionPlan">
		UPDATE TPR301
		SET
			USE_YN = 'N',
			OPMAN_CODE2 = #{opmanCode2},
			OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = #{factoryCode}
		  AND PLAN_NO = #{planNo}
		  AND PLAN_SEQ = #{planSeq}
	</update>

	<!-- 생산계획 참조(주문연결) 등록 -->
	<insert id="ProductionPlanDAO.insertProductionPlanReference" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanReference">
		INSERT INTO TPR301R (
			FACTORY_CODE,
			ORDER_NO,
			ORDER_SEQNO,
			ORDER_HISTNO,
			PRODPLAN_DATE,
			PRODPLAN_SEQ,
			ORDER_QTY,
			WORKDT_QTY,
			REPRESENT_ORDER
		) VALUES (
			#{factoryCode},
			#{orderNo},
			#{orderSeqno},
			#{orderHistno},
			#{prodplanDate},
			#{prodplanSeq},
			ISNULL(#{orderQty}, 0),
			ISNULL(#{workdtQty}, 0),
			ISNULL(#{representOrder}, 'N')
		)
	</insert>

	<!-- 작업장별 주간 생산계획 조회 (설비별 그룹화) -->
	<select id="ProductionPlanDAO.selectWeeklyProductionPlansByWorkplace" parameterType="egovframework.let.production.plan.domain.model.ProductionPlanVO" resultType="egovMap">
		SELECT
			E.EQUIP_SYS_CD AS EQUIPMENT_ID,
			E.EQUIP_CD AS EQUIPMENT_CODE,
			E.EQUIPMENT_NAME,
			D.PLAN_NO,
			D.PLAN_SEQ,
			D.PLAN_DATE,
			D.ITEM_CODE,
			D.ITEM_NAME,
			D.PLANNED_QTY,
			D.ACTUAL_QTY,
			D.SHIFT,
			D.WORKER_CODE,
			D.WORKER_NAME,
			D.ORDER_NO,
			D.ORDER_SEQNO,
			D.ORDER_HISTNO,
			D.CUSTOMER_CODE,
			D.CUSTOMER_NAME,
			D.REMARK
		FROM (
			-- 작업장의 설비연동 설비 목록 조회
			SELECT DISTINCT
				E.FACTORY_CODE,
				E.EQUIP_SYS_CD,
				E.EQUIP_CD,
				E.EQUIPMENT_NAME
			FROM TPR103 WP
				INNER JOIN TPR102 P ON WP.FACTORY_CODE = P.FACTORY_CODE AND WP.WORK_CODE = P.WORK_CODE
				INNER JOIN TPR104 PE ON P.FACTORY_CODE = PE.FACTORY_CODE AND P.WORK_CODE = PE.WORK_CODE
				INNER JOIN TPR151 E ON PE.FACTORY_CODE = E.FACTORY_CODE AND PE.EQUIP_SYS_CD = E.EQUIP_SYS_CD
			WHERE WP.WORKCENTER_CODE = #{workplaceCode}
			  AND P.EQUIPMENT_INTEGRATION_YN = 'Y'
			  AND E.USE_FLAG = 'Y'
		) E
		LEFT JOIN TPR301 D ON E.EQUIP_CD = D.EQUIPMENT_CODE
			AND D.FACTORY_CODE = E.FACTORY_CODE
			AND D.USE_YN = 'Y'
			<if test="startDate != null and startDate != ''">
				AND D.PLAN_DATE &gt;= #{startDate}
			</if>
			<if test="endDate != null and endDate != ''">
				AND D.PLAN_DATE &lt;= #{endDate}
			</if>
		ORDER BY E.EQUIPMENT_NAME, D.PLAN_DATE, D.PLAN_NO, D.PLAN_SEQ
	</select>

</mapper>
