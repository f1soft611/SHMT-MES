<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProductionOrderDAO">

	<!-- 생산계획 조회	-->
	<select id="selectProdPlan"
			parameterType="map"
			resultType="map">
		SELECT B.ORDER_FLAG,
			   A.FACTORY_CODE,
			   A.PRODPLAN_DATE,
			   A.PRODPLAN_SEQ,
			   A.PRODWORK_SEQ,
			   A.PRODPLAN_ID,
			   A.PROD_DATE,
			   A.ITEM_CODE AS ITEM_CODE_ID,
			   B1.MATERIAL_CODE AS ITEM_CODE,
			   A.ITEM_NAME,
			   A.WORKCENTER_CODE,
			   C.WORKCENTER_NAME,
			   A.WORK_CODE,
			   A.EQUIP_SYS_CD,
			   D.EQUIPMENT_NAME,
			   A.WORKER_TYPE,
			   A.WORKER_CODE,
			   A.WORKER_NAME,
			   A.LOT_NO,
			   A.PROD_QTY,
			   A.WORKORDER_SEQ,
			   A.BIGO,
			   A.SEL_CUSTOMER_NAMES,
			   A.OPMAN_CODE,
			   A.OPTIME,
			   A.OPMAN_CODE2,
			   A.OPTIME2
		FROM TPR301 A
		INNER JOIN TPR301M B
		ON A.FACTORY_CODE = B.FACTORY_CODE
		AND A.PRODPLAN_DATE = B.PRODPLAN_DATE
		AND A.PRODPLAN_SEQ = B.PRODPLAN_SEQ
			LEFT JOIN TCO403 B1
			ON A.ITEM_CODE = B1.MATERIAL_ID
		LEFT JOIN TPR101 C
		ON A.WORKCENTER_CODE = C.WORKCENTER_CODE
		LEFT JOIN TPR151 D
		ON A.EQUIP_SYS_CD = D.EQUIP_SYS_CD
		WHERE 1=1
		    AND A.PRODPLAN_DATE BETWEEN #{dateFrom} AND #{dateTo}
			<if test="workplace != null and workplace != ''">
				AND A.WORKCENTER_CODE = #{workplace}
			</if>
		ORDER BY PROD_DATE DESC
		OFFSET #{offset} ROWS
		FETCH NEXT #{size} ROWS ONLY
	</select>

	<select id="selectProdPlanCount"
			parameterType="map"
			resultType="int">
		SELECT COUNT(*)
		FROM TPR301 A
		INNER JOIN TPR301M B
		ON A.FACTORY_CODE = B.FACTORY_CODE
		AND A.PRODPLAN_DATE = B.PRODPLAN_DATE
		AND A.PRODPLAN_SEQ = B.PRODPLAN_SEQ
		WHERE 1=1
		AND A.PRODPLAN_DATE BETWEEN #{dateFrom} AND #{dateTo}
		<if test="workplace != null and workplace != ''">
			AND A.WORKCENTER_CODE = #{workplace}
		</if>
	</select>


	<!--	작업지시가 등록되기 전 공정별 생산제품 조회 코드-->
	<select id="selectFlowProcess"
			parameterType="string"
			resultType="map">
		SELECT	ROW_NUMBER() OVER(ORDER BY A.PRODPLAN_DATE, A.PRODPLAN_SEQ, A.PRODWORK_SEQ, D.SEQ, D.WORK_SEQ) AS IDX,
			A.PRODPLAN_ID,
			A.PRODPLAN_DATE,
			A.PRODPLAN_SEQ,
			A1.ORDER_FLAG,
			A.PRODPLAN_DATE AS WORKDT_DATE,
			A.ITEM_CODE AS ITEM_CODE_ID,
			A2.MATERIAL_CODE AS ITEM_CODE,
			F.MAT_ITEM_SEQ AS PROD_CODE_ID,
			F1.MATERIAL_CODE AS PROD_CODE,
			F1.MATERIAL_NAME,
			F1.MATERIAL_SPEC,
			F2.CODE_NM AS MATERIAL_UNIT,
			D.WORK_CODE,
			D1.WORK_NAME,
			D.WORK_SEQ,
			D.SEQ AS PRODWORK_SEQ,
			E1.EQUIP_SYS_CD AS EQUIPMENT_CODE,
			E1.EQUIPMENT_NAME,
			C.WORK_ORDER,
			C.WORK_ORDER_NM,
			D.LAST_FLAG,
			A.PROD_QTY AS ORDER_QTY,
			CAST(F.NEED_QTY_NUMERATOR/F.NEED_QTY_DENOMINATOR AS DECIMAL(19,2)) AS LABORCOST,
			ISNULL(A.BIGO, '') AS BIGO,
			'' AS OPMAN_CODE2,
			'' AS OPTIME2,
			0 AS RST_CNT,
			'' AS PRODORDER_ID,
			0 AS ORDER_SEQ
		FROM TPR301 A
		    LEFT JOIN TPR301M A1
			ON A.FACTORY_CODE = A1.FACTORY_CODE
			AND A.PRODPLAN_DATE = A1.PRODPLAN_DATE
			AND A.PRODPLAN_SEQ = A1.PRODPLAN_SEQ

			LEFT JOIN TCO403 A2
			ON A.ITEM_CODE = A2.MATERIAL_ID

			LEFT JOIN TPR112 B
			ON A.ITEM_CODE = B.PROD_CODE_ID
			LEFT JOIN TPR110 C
			ON B.FACTORY_CODE = C.FACTORY_CODE
			AND B.WORK_ORDER = C.WORK_ORDER

			LEFT JOIN TPR110D D
			ON C.FACTORY_CODE = D.FACTORY_CODE
			AND C.WORK_ORDER = D.WORK_ORDER
			LEFT JOIN TPR102 D1
			ON D.WORK_CODE = D1.WORK_CODE

			LEFT JOIN TPR104 E
			ON D.WORK_CODE = E.WORK_CODE
			AND A.EQUIP_SYS_CD = E.EQUIP_SYS_CD
				LEFT JOIN TPR151 E1
				ON E.EQUIP_SYS_CD = E1.EQUIP_SYS_CD

			LEFT JOIN TCO501 F
			ON F.ITEM_SEQ = A.ITEM_CODE
			AND F.PROC_SEQ = D.WORK_CODE
				LEFT JOIN TCO403 F1
				ON MAT_ITEM_SEQ = F1.MATERIAL_ID
				LEFT JOIN MES_CCMMNDETAIL_CODE F2
				ON F2.CODE_ID = 'COM007'
				AND F1.UNIT = F2.CODE
		WHERE A.PRODPLAN_ID = #{value}
		ORDER BY A.PRODPLAN_DATE, A.PRODPLAN_SEQ, A.PRODWORK_SEQ, D.SEQ, D.WORK_SEQ
	</select>


	<!--	작업지시 조회 by planId-->
	<select id="selectProdOrders"
			parameterType="string"
			resultType="map">
		SELECT
			ROW_NUMBER() OVER( ORDER BY PRODPLAN_DATE, PRODPLAN_SEQ, PRODWORK_SEQ, WORKORDER_SEQ) AS IDX,
			A.FACTORY_CODE,
			A.PRODPLAN_DATE,
			A.PRODPLAN_SEQ,
			A.PRODWORK_SEQ,
			A.WORK_SEQ AS ORDER_SEQ,
			A.PRODPLAN_ID,
			A.PRODORDER_ID,
			A.WORKORDER_SEQ,
			A.WORK_CODE,
			B.WORK_NAME,
			D1.EQUIP_SYS_CD AS EQUIPMENT_CODE,
			D1.EQUIPMENT_NAME,
			A.WORKDT_DATE,
			A.ITEM_CODE AS ITEM_CODE_ID,
			A1.MATERIAL_CODE AS ITEM_CODE,
			A.PROD_CODE AS PROD_CODE_ID,
			C.MATERIAL_CODE AS PROD_CODE,
			C.MATERIAL_NAME,
			C.MATERIAL_SPEC,
			C1.CODE_NM AS MATERIAL_UNIT,
			A.ORDER_FLAG,
			A.LOT_NO,
			A.PROD_QTY AS ORDER_QTY,
			ISNULL(A.OPMAN_CODE2, A.OPMAN_CODE) AS OPMAN_CODE2,
			ISNULL(A.OPTIME2, A.OPTIME) AS OPTIME2,
			(
			    SELECT COUNT(*)
				FROM TPR601 X
				WHERE A.FACTORY_CODE = X.FACTORY_CODE
				  AND A.PRODPLAN_DATE = X.PRODPLAN_DATE
				  AND A.PRODPLAN_SEQ = X.PRODPLAN_SEQ
				  AND A.PRODWORK_SEQ = X.PRODWORK_SEQ
				  AND A.WORK_SEQ = X.WORK_SEQ
			) AS RST_CNT
		FROM TPR504 A
			LEFT JOIN TCO403 A1
			ON A.ITEM_CODE = A1.MATERIAL_ID

			LEFT JOIN TPR102 B
			ON A.WORK_CODE = B.WORK_CODE

			LEFT JOIN TCO403 C
			ON A.PROD_CODE = C.MATERIAL_ID
				LEFT JOIN MES_CCMMNDETAIL_CODE C1
				ON C1.CODE_ID = 'COM007'
				AND C.UNIT = C1.CODE

			LEFT JOIN TPR104 D
			ON A.WORK_CODE = D.WORK_CODE
			AND A.EQUIP_SYS_CD = D.EQUIP_SYS_CD

			LEFT JOIN TPR151 D1
			ON D.EQUIP_SYS_CD = D1.EQUIP_SYS_CD
		WHERE A.PRODPLAN_ID = #{value}
		ORDER BY PRODPLAN_DATE, PRODPLAN_SEQ, PRODWORK_SEQ, WORKORDER_SEQ;
	</select>

	<!-- 생산지시 TPR504 NextId 가져오기    -->
	<select id="selectProdOrderNextId" resultType="string">
		SELECT
			'PO' + CONVERT(char(8), GETDATE(), 112)
				+ RIGHT('0000' +
			CAST(
			ISNULL(
			MAX(CAST(RIGHT(TPR504ID, 4) AS INT)), 0
			) + 1
			AS varchar),
			4
			) AS NEXT_ID
		FROM TPR504
		WHERE TPR504ID LIKE  'PO' + CONVERT(char(8), GETDATE(), 112) + '%'
	</select>

	<!-- 생산지시 INSERT 전 WORK_SEQ 값 가져오기	-->
	<select id="selectProdOrderWorkSeq" parameterType="map" resultType="int">
		SELECT COUNT(*)+1
		FROM TPR504
		WHERE FACTORY_CODE = '000001'
		AND PRODPLAN_DATE = #{PRODPLAN_DATE}
		AND PRODPLAN_SEQ = #{PRODPLAN_SEQ}
	</select>

	<!-- 생산지시 INSERT	-->
	<insert id="insertProductionOrder"
			parameterType="map">
		INSERT INTO TPR504(
			FACTORY_CODE,
			PRODPLAN_DATE,
			PRODPLAN_SEQ,
			PRODWORK_SEQ,
			WORK_SEQ,
			PRODPLAN_ID,
			PRODORDER_ID,
			WORKORDER_SEQ,
			WORK_CODE,
			WORKDT_DATE,
			ITEM_CODE,
		    PROD_CODE,
			EQUIP_SYS_CD,
			ORDER_FLAG,
			LOT_NO,
			PROD_QTY,
			OPMAN_CODE,
			OPTIME,
		    TPR504ID
		)
		VALUES (
			'000001',
			#{PRODPLAN_DATE},
			#{PRODPLAN_SEQ},
			#{PRODWORK_SEQ},
			#{ORDER_SEQ},
			#{PRODPLAN_ID},
			#{PRODORDER_ID},
			#{NEW_WORKORDER_SEQ},
			#{WORK_CODE},
			#{WORKDT_DATE},
			#{ITEM_CODE_ID},
			#{PROD_CODE_ID},
		    #{EQUIPMENT_CODE},
			'O',
			#{LOT_NO},
			#{ORDER_QTY},
			#{OPMAN_CODE},
			GETDATE(),
			#{PRODORDER_ID}
		);
	</insert>

	<!-- TPR301M ORDER_FLAG UPDATE
	1. 생산지시 저장 후 update
	2. 생산지시 삭제 후 update	-->
	<update id="updateProdPlanOrderFlag" parameterType="map">
		UPDATE TPR301M SET ORDER_FLAG = #{ORDER_FLAG}
		WHERE FACTORY_CODE = '000001'
		AND PRODPLAN_DATE = #{PRODPLAN_DATE}
		AND PRODPLAN_SEQ = #{PRODPLAN_SEQ}
	</update>

	
	<!-- 생산지시 삭제	-->
	<delete id="deleteProductionOrder" parameterType="map">
		DELETE FROM TPR504
		WHERE FACTORY_CODE = '000001'
		AND PRODPLAN_DATE = #{PRODPLAN_DATE}
		AND PRODPLAN_SEQ = #{PRODPLAN_SEQ}
	</delete>

	<!-- 해당 생산지시에 등록된 생산실적 확인 -->
	<select id="selectProdResultCount"
			parameterType="map"
			resultType="int">
		SELECT COUNT(*)
		FROM TPR601
		WHERE FACTORY_CODE = '000001'
		AND PRODPLAN_DATE = #{PRODPLAN_DATE}
		AND PRODPLAN_SEQ = #{PRODPLAN_SEQ}
	</select>


	<!-- 생산지시 수정	-->
	<update id="updateProductionOrder" parameterType="map">
		UPDATE TPR504 SET WORKDT_DATE = #{WORKDT_DATE},
						  PROD_QTY = #{ORDER_QTY},
						  WORKORDER_SEQ = #{NEW_WORKORDER_SEQ},
						  OPMAN_CODE2 = #{OPMAN_CODE},
						  OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = '000001'
		  AND PRODPLAN_DATE = #{PRODPLAN_DATE}
		  AND PRODPLAN_SEQ = #{PRODPLAN_SEQ}
		  AND WORK_SEQ = #{ORDER_SEQ}
	</update>

</mapper>
