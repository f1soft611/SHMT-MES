<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProductionResultDAO">

    <!-- 생산지시 목록 조회    -->
    <select id="selectProductionOrderList"
            parameterType="egovframework.let.production.result.domain.model.ProdResultSearchDto"
            resultType="egovframework.let.production.result.domain.model.ProdResultOrderRow">
        SELECT X.ORDER_NO, X.ORDER_SEQNO, X.ORDER_HISTNO, X.CUSTOMER_CODE, X1.CUSTOMER_NAME
            , A.FACTORY_CODE
            , A.PRODPLAN_ID
            , A.PRODPLAN_DATE
            , A.PRODPLAN_SEQ
            , A.PRODWORK_SEQ
            , CAST(A.WORK_SEQ AS INT) AS WORK_SEQ
            , A.WORKDT_DATE
            , A1.WORKCENTER_CODE
            , A2.WORKCENTER_NAME
            , A.WORK_CODE
            , B.WORK_NAME
            , ISNULL(A.ITEM_CODE, '') AS ITEM_CODE_ID
            , ISNULL(C.MATERIAL_CODE, '') AS ITEM_CODE
            , ISNULL(C.MATERIAL_NAME, '') AS ITEM_NAME
            , ISNULL(A.PROD_CODE, '') AS PROD_CODE_ID
            , ISNULL(C1.MATERIAL_CODE, '') AS PROD_CODE
            , ISNULL(C1.MATERIAL_NAME, '') AS PROD_NAME
            , ISNULL(C1.MATERIAL_SPEC, '') AS PROD_SPEC
            , ISNULL(A.EQUIP_SYS_CD, '') AS EQUIP_SYS_CD
            , ISNULL(D.EQUIPMENT_NAME, '') AS EQUIP_SYS_CD_NM
            , A.PROD_QTY
            , A.ORDER_FLAG
            , A.WORKORDER_SEQ
            , A.LOT_NO
            , A.ERP_SEND_FLAG
            , A.ERP_WORKDT_IDX
            , A.BIGO
            , A.OPMAN_CODE
            , A.OPTIME
            , A.OPMAN_CODE2
            , A.OPTIME2
            , A.TPR504ID
            , A.PRODORDER_ID
        FROM TPR504 A
            LEFT JOIN TPR301 A1
            ON A.FACTORY_CODE = A1.FACTORY_CODE
            AND A.PRODPLAN_DATE = A1.PRODPLAN_DATE
            AND A.PRODPLAN_SEQ = A1.PRODPLAN_SEQ
            AND A.PRODWORK_SEQ = A1.PRODWORK_SEQ
            LEFT JOIN TPR101 A2
            ON A1.WORKCENTER_CODE = A2.WORKCENTER_CODE
        LEFT JOIN TPR102 B
        ON A.FACTORY_CODE = B.FACTORY_CODE
        AND A.WORK_CODE = B.WORK_CODE
        LEFT JOIN TCO403 C
        ON A.ITEM_CODE = C.MATERIAL_ID
        LEFT JOIN TCO403 C1
        ON A.PROD_CODE = C1.MATERIAL_ID
        LEFT JOIN TPR151 D
        ON A.EQUIP_SYS_CD = D.EQUIP_SYS_CD
        LEFT JOIN TPR301R X
        ON A1.FACTORY_CODE = X.FACTORY_CODE
        AND A1.PRODPLAN_DATE = X.PRODPLAN_DATE
        AND A1.PRODPLAN_SEQ = X.PRODPLAN_SEQ
        LEFT JOIN TCO601 X1
        ON X.CUSTOMER_CODE = X1.CUSTOMER_CODE
        WHERE 1=1
        AND A.WORKDT_DATE BETWEEN #{dateFrom} AND #{dateTo}
        <if test="workplace != null and workplace != ''">
            AND A1.WORKCENTER_CODE = #{workplace}
        </if>
        <if test="equipment != null and equipment != ''">
            AND A.EQUIP_SYS_CD = #{equipment}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                A.ITEM_CODE      LIKE '%' + #{keyword} + '%'
                OR C.MATERIAL_NAME  LIKE '%' + #{keyword} + '%'
                OR D.EQUIPMENT_NAME LIKE '%' + #{keyword} + '%'
                OR B.WORK_NAME      LIKE '%' + #{keyword} + '%'
                OR A.PRODPLAN_ID    LIKE '%' + #{keyword} + '%'
            )
        </if>
        ORDER BY ORDER_NO, ORDER_SEQNO, ORDER_HISTNO
               , A.PRODPLAN_DATE, A.PRODPLAN_SEQ
               , CAST(A.PRODWORK_SEQ AS INT)
               , CAST(A.WORK_SEQ AS INT), A.WORKDT_DATE DESC
        OFFSET #{offset} ROWS
        FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 생산지시 목록 전체 건 수    -->
    <select id="selectProductionOrderListCount"
            parameterType="egovframework.let.production.result.domain.model.ProdResultSearchDto"
            resultType="int">
        SELECT COUNT(*)
        FROM TPR504 A
        LEFT JOIN TPR301 A1
        ON A.FACTORY_CODE = A1.FACTORY_CODE
        AND A.PRODPLAN_DATE = A1.PRODPLAN_DATE
        AND A.PRODPLAN_SEQ = A1.PRODPLAN_SEQ
        AND A.PRODWORK_SEQ = A1.PRODWORK_SEQ
        LEFT JOIN TPR101 A2
        ON A1.WORKCENTER_CODE = A2.WORKCENTER_CODE
        LEFT JOIN TPR102 B
        ON A.FACTORY_CODE = B.FACTORY_CODE
        AND A.WORK_CODE = B.WORK_CODE
        LEFT JOIN TCO403 C
        ON A.ITEM_CODE = C.MATERIAL_ID
        LEFT JOIN TPR151 D
        ON A.EQUIP_SYS_CD = D.EQUIP_SYS_CD
        LEFT JOIN TPR301R X --수주정보
        ON A1.PRODPLAN_DATE = X.PRODPLAN_DATE
        AND A1.PRODPLAN_SEQ = X.PRODPLAN_SEQ
        --AND X.ORDER_HISTNO  = 1
        LEFT JOIN TCO601 X1
        ON X.CUSTOMER_CODE = X1.CUSTOMER_CODE
        WHERE 1=1
        AND A.WORKDT_DATE BETWEEN #{dateFrom} AND #{dateTo}
        <if test="workplace != null and workplace != ''">
            AND A1.WORKCENTER_CODE = #{workplace}
        </if>
        <if test="equipment != null and equipment != ''">
            AND A.EQUIP_SYS_CD = #{equipment}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
            A.ITEM_CODE      LIKE '%' + #{keyword} + '%'
            OR C.MATERIAL_NAME  LIKE '%' + #{keyword} + '%'
            OR D.EQUIPMENT_NAME LIKE '%' + #{keyword} + '%'
            OR B.WORK_NAME      LIKE '%' + #{keyword} + '%'
            OR A.PRODPLAN_ID    LIKE '%' + #{keyword} + '%'
            )
        </if>
    </select>

    <!-- 생산실적 TPR601 NextId 가져오기    -->
    <select id="selectProdResultNextId"
            resultType="string">
        SELECT
            'PR' + CONVERT(char(8), GETDATE(), 112)
                + RIGHT('0000' +
            CAST(
            ISNULL(
            MAX(CAST(RIGHT(TPR601ID, 4) AS INT)), 0
            ) + 1
            AS varchar),
            4
            ) AS NEXT_ID
        FROM TPR601
        WHERE TPR601ID LIKE 'PR' + CONVERT(char(8), GETDATE(), 112) + '%'
    </select>

    <!-- 생산실적 TPR601 prod_seq 가져오기  -->
    <select id="selectProdSeq"
            parameterType="map"
            resultType="int">
        SELECT COUNT(*)+1
        FROM TPR601
        WHERE FACTORY_CODE = #{factoryCode}
        AND PRODPLAN_DATE = #{prodplanDate}
        AND PRODPLAN_SEQ = #{prodplanSeq}
        AND PRODWORK_SEQ = #{prodworkSeq}
        AND WORK_SEQ = #{workSeq}
    </select>

    <!-- 생산실적 TPR601 저장   -->
    <insert id="insertProductionResult"
            parameterType="egovframework.let.production.result.domain.model.ProdResultInsertDto">
        INSERT INTO TPR601(
            FACTORY_CODE,
            PRODPLAN_DATE,
            PRODPLAN_SEQ,
            PRODWORK_SEQ,
            WORK_SEQ,
            PROD_SEQ,
            ITEM_CODE,
            WORK_CODE,
            PROD_STIME,
            PROD_ETIME,
            ORDER_FLAG,
            PROD_QTY,
            GOOD_QTY,
            BAD_QTY,
            RCV_QTY,
            WORKORDER_SEQ,
            TPR601ID,
            TPR504ID,
            OPMAN_CODE,
            OPTIME
        )
        VALUES (
            '000001',
            #{prodplanDate},
            #{prodplanSeq},
            #{prodworkSeq},
            #{workSeq},
            #{prodSeq},
            #{itemCode},
            #{workCode},
            #{prodStime},
            #{prodEtime},
            #{orderFlag},
            #{prodQty},
            #{goodQty},
            #{badQty},
            #{rcvQty},
            #{prodSeq},
            #{tpr601Id},
            #{tpr504Id},
            #{opmanCode},
            GETDATE()
        )
    </insert>

    <!-- 생산실적 TPR601 수정   -->
    <update id="updateProductionResult"
            parameterType="egovframework.let.production.result.domain.model.ProdResultUpdateDto">
        UPDATE TPR601 SET PROD_STIME = #{prodStime},
                          PROD_ETIME = #{prodEtime},
                          PROD_QTY = #{prodQty},
                          GOOD_QTY = #{goodQty},
                          BAD_QTY = #{badQty},
                          RCV_QTY = #{rcvQty},
                          OPMAN_CODE2 = #{opmanCode},
                          OPTIME2 = GETDATE()
        WHERE FACTORY_CODE = '000001'
        AND PRODPLAN_DATE = #{prodplanDate}
        AND PRODPLAN_SEQ = #{prodplanSeq}
        AND PRODWORK_SEQ = #{prodworkSeq}
        AND WORK_SEQ = #{workSeq}
        AND PROD_SEQ = #{prodSeq}
    </update>

    <!-- 생산실적 TPR601 삭제   -->
    <delete id="deleteProductionResult"
            parameterType="egovframework.let.production.result.domain.model.ProdResultDeleteDto">
        DELETE FROM TPR601
        WHERE FACTORY_CODE = '000001'
          AND PRODPLAN_DATE = #{prodplanDate}
          AND PRODPLAN_SEQ = #{prodplanSeq}
          AND PRODWORK_SEQ = #{prodworkSeq}
          AND WORK_SEQ = #{workSeq}
          AND PROD_SEQ = #{prodSeq}
    </delete>

    <!-- 생산실적 작업자 TPR601W NextId 가져오기    -->
    <select id="selectProdResultWorkerNextId"
            resultType="string">
        SELECT
            'PRW' + CONVERT(char(8), GETDATE(), 112)
                + RIGHT('000' +
            CAST(
            ISNULL(
            MAX(CAST(RIGHT(TPR601WID, 3) AS INT)), 0
            ) + 1
            AS varchar),
            3
            ) AS NEXT_ID
        FROM TPR601W
        WHERE TPR601WID LIKE 'PRW' + CONVERT(char(8), GETDATE(), 112) + '%'
    </select>


    <!-- 생산실적 작업자 TPR601W seq 가져오기  -->
    <select id="selectProdResultWorkerSeq"
            parameterType="egovframework.let.production.result.domain.model.ProdResultWorkerDto"
            resultType="int">
        SELECT COUNT(*)+1
        FROM TPR601W
        WHERE FACTORY_CODE = #{factoryCode}
          AND PRODPLAN_DATE = #{prodplanDate}
          AND PRODPLAN_SEQ = #{prodplanSeq}
          AND PRODWORK_SEQ = #{prodworkSeq}
          AND WORK_SEQ = #{workSeq}
          AND PROD_SEQ = #{prodSeq}
    </select>

    <!-- 생산실적 작업자 TPR601W 저장   -->
    <insert id="insertProductionResultWorker" parameterType="egovframework.let.production.result.domain.model.ProdResultWorkerDto">
        INSERT INTO TPR601W(
            FACTORY_CODE,
            PRODPLAN_DATE,
            PRODPLAN_SEQ,
            PRODWORK_SEQ,
            WORK_SEQ,
            PROD_SEQ,
            WORKER_SEQ,
            WORKER_CODE,
            TPR601WID,
            TPR601ID
        )
        VALUES (
                   '000001',
                   #{prodplanDate},
                   #{prodplanSeq},
                   #{prodworkSeq},
                   #{workSeq},
                   #{prodSeq},
                   #{workerSeq},
                   #{workerCode},
                   #{tpr601wId},
                   #{tpr601Id}
               )
    </insert>

    <!-- 생산실적 작업자 TPR601W 삭제   -->
    <delete id="deleteProductionResultWorker"
            parameterType="java.lang.Object">
        DELETE FROM TPR601W
        WHERE FACTORY_CODE = '000001'
        AND PRODPLAN_DATE = #{prodplanDate}
        AND PRODPLAN_SEQ = #{prodplanSeq}
        AND PRODWORK_SEQ = #{prodworkSeq}
        AND WORK_SEQ = #{workSeq}
        AND PROD_SEQ = #{prodSeq}
    </delete>


    <!-- 생산실적 투입자재 TPR601M 삭제   -->
    <delete id="deleteProductionResultMaterial"
            parameterType="egovframework.let.production.result.domain.model.ProdResultDetailParent">
        DELETE FROM TPR601M
        WHERE FACTORY_CODE = '000001'
          AND PRODPLAN_DATE = #{prodplanDate}
          AND PRODPLAN_SEQ = #{prodplanSeq}
          AND PRODWORK_SEQ = #{prodworkSeq}
          AND WORK_SEQ = #{workSeq}
          AND PROD_SEQ = #{prodSeq}
    </delete>


    <!-- 생산실적 저장 후 TPR504 ORDER_FLAG UPDATE  -->
    <update id="updateProdOrderOrderFlag" parameterType="egovframework.let.production.result.domain.model.ProdResultOrderFlagDto">
        UPDATE TPR504 SET ORDER_FLAG = #{orderFlag}
        WHERE FACTORY_CODE = '000001'
        AND PRODPLAN_DATE = #{prodplanDate}
        AND PRODPLAN_SEQ = #{prodplanSeq}
    </update>


    <!-- 생산실적 detail 조회  -->
    <select id="selectProductionResultDetailList"
            parameterType="egovframework.let.production.result.domain.model.ProdResultDto"
            resultType="egovframework.let.production.result.domain.model.ProdResultRow">
        SELECT A.*,
               STUFF((
                         SELECT ',' + X.WORKER_CODE
                         FROM TPR601W X
                         WHERE X.FACTORY_CODE  = A.FACTORY_CODE
                           AND X.PRODPLAN_DATE = A.PRODPLAN_DATE
                           AND X.PRODPLAN_SEQ  = A.PRODPLAN_SEQ
                           AND X.PRODWORK_SEQ  = A.PRODWORK_SEQ
                           AND X.WORK_SEQ      = A.WORK_SEQ
                           AND X.PROD_SEQ      = A.PROD_SEQ
                         FOR XML PATH(''), TYPE
                   ).value('.', 'varchar(max)'), 1, 1, '') AS workerCodes
        FROM TPR601 A
        WHERE A.FACTORY_CODE = '000001'
        AND A.PRODPLAN_DATE = #{prodplanDate}
        AND A.PRODPLAN_SEQ = #{prodplanSeq}
        AND A.PRODWORK_SEQ = #{prodworkSeq}
        AND A.WORK_SEQ = #{workSeq}
    </select>


</mapper>
