<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="WorkplaceDAO">

	<resultMap id="workplaceResult" type="egovframework.let.basedata.workplace.domain.model.Workplace">
		<result property="factoryCode" column="FACTORY_CODE"/>
		<result property="workplaceId" column="WORKCENTER_ID"/>
		<result property="workplaceCode" column="WORKCENTER_CODE"/>
		<result property="workplaceName" column="WORKCENTER_NAME"/>
		<result property="workplaceType" column="WORKCENTER_TYPE"/>
		<result property="description" column="DESCRIPTION"/>
		<result property="location" column="LOCATION"/>
		<result property="status" column="STATUS"/>
		<result property="useYn" column="USE_YN"/>
		<result property="proCnt" column="PRO_CNT"/>
		<result property="workerCnt" column="WORKER_CNT"/>
		<result property="regUserId" column="OPMAN_CODE"/>
		<result property="regDt" column="OPTIME"/>
		<result property="updUserId" column="OPMAN_CODE2"/>
		<result property="updDt" column="OPTIME2"/>
	</resultMap>

	<select id="WorkplaceDAO.selectWorkplaceList" parameterType="egovframework.let.basedata.workplace.domain.model.WorkplaceVO" resultMap="workplaceResult">
		SELECT
		W.FACTORY_CODE,
		W.WORKCENTER_ID,
		W.WORKCENTER_CODE,
		W.WORKCENTER_NAME,
		W.WORKCENTER_TYPE,
		W.DESCRIPTION,
		W.LOCATION,
		W.STATUS,
		W.USE_YN,
		W.OPMAN_CODE,
		CONVERT(VARCHAR(19), W.OPTIME, 120) AS OPTIME,
		W.OPMAN_CODE2,
		CONVERT(VARCHAR(19), W.OPTIME2, 120) AS OPTIME2,
		ISNULL(PC.CNT, 0) AS PRO_CNT,
		ISNULL(WC.CNT, 0) AS WORKER_CNT
		FROM TPR101 W
			LEFT JOIN (
				SELECT
					FACTORY_CODE,
					WORKCENTER_CODE,
					COUNT(*) AS CNT
				FROM TPR103
				WHERE USE_YN = 'Y'
				GROUP BY FACTORY_CODE, WORKCENTER_CODE
			) PC ON W.FACTORY_CODE = PC.FACTORY_CODE
			    AND W.WORKCENTER_CODE = PC.WORKCENTER_CODE

			LEFT JOIN (
				SELECT
					FACTORY_CODE,
					WORKCENTER_CODE,
					COUNT(*) AS CNT
				FROM TPR106
				WHERE USE_YN = 'Y'
				GROUP BY FACTORY_CODE, WORKCENTER_CODE
			) WC ON W.FACTORY_CODE = WC.FACTORY_CODE
				AND W.WORKCENTER_CODE = WC.WORKCENTER_CODE
		WHERE 1=1
		<if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
			<choose>
				<when test="searchCnd == 0">
					AND W.WORKCENTER_CODE LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == 1">
					AND W.WORKCENTER_NAME LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == 2">
					AND W.LOCATION LIKE '%' + #{searchWrd} + '%'
				</when>
			</choose>
		</if>
		<if test="status != null and status != ''">
			AND W.STATUS = #{status}
		</if>
		AND W.USE_YN = 'Y'
		ORDER BY W.OPTIME DESC
		<if test="firstIndex != null and recordCountPerPage != null">
			OFFSET #{firstIndex} ROWS
			FETCH NEXT #{recordCountPerPage} ROWS ONLY
		</if>
	</select>

	<select id="WorkplaceDAO.selectWorkplaceListCnt" parameterType="egovframework.let.basedata.workplace.domain.model.WorkplaceVO" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR101
		WHERE 1=1
		<if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
			<choose>
				<when test="searchCnd == '0'">
					AND WORKCENTER_CODE LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == '1'">
					AND WORKCENTER_NAME LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == '2'">
					AND LOCATION LIKE '%' + #{searchWrd} + '%'
				</when>
			</choose>
		</if>
		<if test="status != null and status != ''">
			AND STATUS = #{status}
		</if>
		<if test="useYn != null and useYn != ''">
			AND USE_YN = #{useYn}
		</if>
	</select>

	<select id="WorkplaceDAO.selectWorkplace" parameterType="string" resultMap="workplaceResult">
		SELECT
		    FACTORY_CODE,
			WORKCENTER_ID,
			WORKCENTER_CODE,
			WORKCENTER_NAME,
			DESCRIPTION,
			LOCATION,
			WORKCENTER_TYPE,
			STATUS,
			USE_YN,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2,
			0 AS PRO_CNT,
			0 AS WORKER_CNT
		FROM TPR101
		WHERE WORKCENTER_ID = #{workplaceId}
	</select>

	<insert id="WorkplaceDAO.insertWorkplace" parameterType="egovframework.let.basedata.workplace.domain.model.Workplace">
		INSERT INTO TPR101 (
		    FACTORY_CODE,
			WORKCENTER_ID,
			WORKCENTER_CODE,
			WORKCENTER_NAME,
			DESCRIPTION,
			LOCATION,
			WORKCENTER_TYPE,
			STATUS,
			USE_YN,
			OPMAN_CODE,
			OPTIME
		) VALUES (
					 #{factoryCode},
					 #{workplaceId},
					 #{workplaceCode},
					 #{workplaceName},
					 #{description},
					 #{location},
					 #{workplaceType},
					 ISNULL(#{status}, 'ACTIVE'),
					 ISNULL(#{useYn}, 'Y'),
					 #{regUserId},
					 GETDATE()
				 )
	</insert>

	<update id="WorkplaceDAO.updateWorkplace" parameterType="egovframework.let.basedata.workplace.domain.model.Workplace">
		UPDATE TPR101
		SET
			WORKCENTER_CODE = #{workplaceCode},
			WORKCENTER_NAME = #{workplaceName},
			DESCRIPTION = #{description},
			LOCATION = #{location},
			WORKCENTER_TYPE = #{workplaceType},
			STATUS = #{status},
			USE_YN = #{useYn},
			OPMAN_CODE2 = #{updUserId},
			OPTIME2 = GETDATE()
		WHERE WORKCENTER_ID = #{workplaceId}
	</update>

	<delete id="WorkplaceDAO.deleteWorkplace" parameterType="string">
		DELETE FROM TPR101
		WHERE WORKCENTER_ID = #{workplaceId}
	</delete>

	<!-- 작업장 코드 중복 체크 -->
	<select id="WorkplaceDAO.selectWorkplaceCodeCheck" parameterType="string" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR101
		WHERE WORKCENTER_CODE = #{workplaceCode}
	</select>

	<!-- 작업장 코드 중복 체크 (수정 시) -->
	<select id="WorkplaceDAO.selectWorkplaceCodeCheckForUpdate" parameterType="map" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR101
		WHERE WORKCENTER_CODE = #{workplaceCode}
		  AND WORKCENTER_ID != #{workplaceId}
	</select>

</mapper>