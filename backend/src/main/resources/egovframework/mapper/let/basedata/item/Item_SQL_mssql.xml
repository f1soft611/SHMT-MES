<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ItemDAO">

	<resultMap id="itemResult" type="egovframework.let.basedata.item.domain.model.Item">
		<result property="factoryCode" column="FACTORY_CODE"/>
		<result property="itemId" column="MATERIAL_ID"/>
		<result property="itemCode" column="MATERIAL_CODE"/>
		<result property="itemName" column="MATERIAL_NAME"/>
		<result property="itemType" column="MATERIAL_FLAG"/>
		<result property="specification" column="MATERIAL_SPEC"/>
		<result property="unit" column="UNIT"/>
		<result property="unitName" column="UNIT_NAME"/>
		<result property="stockQty" column="STOCK_QTY"/>
		<result property="safetyStock" column="SAFETY_STOCK"/>
		<result property="productionPerCycle" column="PRODUCTION_PER_CYCLE"/>
		<result property="remark" column="ETC"/>
		<result property="interfaceYn" column="INTERFACE_YN"/>
		<result property="useYn" column="DELETE_FLAG"/>
		<result property="regUserId" column="OPMAN_CODE"/>
		<result property="regDt" column="OPTIME"/>
		<result property="updUserId" column="OPMAN_CODE2"/>
		<result property="updDt" column="OPTIME2"/>
	</resultMap>

	<select id="ItemDAO.selectItemList" parameterType="egovframework.let.basedata.item.domain.model.ItemVO" resultMap="itemResult">
		SELECT
		FACTORY_CODE,
		MATERIAL_ID,
		MATERIAL_CODE,
		MATERIAL_NAME,
		MATERIAL_SPEC,
		MATERIAL_FLAG,
		UNIT,
		ISNULL(CODE1.CODE_NM, '') AS UNIT_NAME,
		STOCK_QTY,
		SAFETY_STOCK,		ISNULL(PRODUCTION_PER_CYCLE, '0') AS PRODUCTION_PER_CYCLE,		ETC,
		INTERFACE_YN,
		CASE WHEN ISNULL(DELETE_FLAG, '0') = '1' THEN 'N' ELSE 'Y' END AS DELETE_FLAG,
		OPMAN_CODE,
		CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
		OPMAN_CODE2,
		CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TCO403 A
			LEFT JOIN MES_CCMMNDETAIL_CODE CODE1
			ON CODE1.CODE_ID = 'COM007'
			AND CODE1.CODE = A.UNIT
		WHERE 1=1
		AND FACTORY_CODE = #{factoryCode}
		<if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
			<choose>
				<when test="searchCnd == 1">
					AND MATERIAL_CODE LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == 2">
					AND MATERIAL_NAME LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == 3">
					AND MATERIAL_SPEC LIKE '%' + #{searchWrd} + '%'
				</when>
			</choose>
		</if>
		<if test="itemType != null and itemType != ''">
			AND MATERIAL_FLAG = #{itemType}
		</if>
		<if test="useYn != null and useYn != ''">
			AND DELETE_FLAG = CASE WHEN #{useYn} = 'Y' THEN '0' ELSE '1' END
		</if>

		<!-- 공정 등록 여부 -->
		<if test="inProcessFlowYn != null">
			<choose>
				<!-- 1: 미등록 -->
				<when test="inProcessFlowYn == 1">
					AND NOT EXISTS (
					SELECT 1
					FROM TPR112 FI
					WHERE FI.PROD_CODE_ID = A.MATERIAL_ID
					)
				</when>

				<!-- 2: 등록 -->
				<when test="inProcessFlowYn == 2">
					AND EXISTS (
					SELECT 1
					FROM TPR_FLOW_ITEM FI
					FROM TPR112 FI
					WHERE FI.PROD_CODE_ID = A.MATERIAL_ID
					)
				</when>

				<!-- 0: 전체 → 조건 없음 -->
			</choose>
		</if>

		ORDER BY OPTIME DESC
		<if test="firstIndex != null and recordCountPerPage != null">
			OFFSET #{firstIndex} ROWS
			FETCH NEXT #{recordCountPerPage} ROWS ONLY
		</if>
	</select>

	<select id="ItemDAO.selectItemListCnt"
			parameterType="egovframework.let.basedata.item.domain.model.ItemVO"
			resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TCO403 A
		WHERE 1=1
		AND FACTORY_CODE = #{factoryCode}
		<if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
			<choose>
				<when test="searchCnd == 1">
					AND MATERIAL_CODE LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == 2">
					AND MATERIAL_NAME LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == 3">
					AND MATERIAL_SPEC LIKE '%' + #{searchWrd} + '%'
				</when>
			</choose>
		</if>
		<if test="itemType != null and itemType != ''">
			AND MATERIAL_FLAG = #{itemType}
		</if>
		<if test="useYn != null and useYn != ''">
			AND DELETE_FLAG = CASE WHEN #{useYn} = 'Y' THEN '0' ELSE '1' END
		</if>
		<!-- 공정 등록 여부 -->
		<if test="inProcessFlowYn != null">
			<choose>
				<!-- 1: 미등록 -->
				<when test="inProcessFlowYn == 1">
					AND NOT EXISTS (
					SELECT 1
					FROM TPR112 FI
					WHERE FI.PROD_CODE_ID = A.MATERIAL_ID
					)
				</when>

				<!-- 2: 등록 -->
				<when test="inProcessFlowYn == 2">
					AND EXISTS (
					SELECT 1
					FROM TPR112 FI
					WHERE FI.PROD_CODE_ID = A.MATERIAL_ID
					)
				</when>

				<!-- 0: 전체 → 조건 없음 -->
			</choose>
		</if>
		AND DELETE_FLAG != '1'
	</select>

	<select id="ItemDAO.selectItem" parameterType="string" resultMap="itemResult">
		SELECT
			FACTORY_CODE,
			MATERIAL_ID,
			MATERIAL_CODE,
			MATERIAL_NAME,
			MATERIAL_SPEC,
			MATERIAL_FLAG,
			UNIT,
			STOCK_QTY,
			SAFETY_STOCK,
			ISNULL(PRODUCTION_PER_CYCLE, '0') AS PRODUCTION_PER_CYCLE,
			ETC,
			INTERFACE_YN,
			CASE WHEN ISNULL(DELETE_FLAG, '0') = '1' THEN 'N' ELSE 'Y' END AS DELETE_FLAG,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TCO403
		WHERE MATERIAL_CODE = #{itemCode}
	</select>

	<insert id="ItemDAO.insertItem" parameterType="egovframework.let.basedata.item.domain.model.Item">
		INSERT INTO TCO403 (
			FACTORY_CODE,
			MATERIAL_ID,
			MATERIAL_CODE,
			MATERIAL_NAME,
			MATERIAL_SPEC,
			MATERIAL_FLAG,
			UNIT,
			STOCK_QTY,
			SAFETY_STOCK,
			PRODUCTION_PER_CYCLE,
			ETC,
			INTERFACE_YN,
			DELETE_FLAG,
			OPMAN_CODE,
			OPTIME
		) VALUES (
					 #{factoryCode},
					 #{itemId},
					 #{itemCode},
					 #{itemName},
					 #{specification},
					 #{itemType},
					 #{unit},
					 ISNULL(#{stockQty}, '0'),
					 ISNULL(#{safetyStock}, '0'),
					 ISNULL(#{productionPerCycle}, '0'),
					 #{remark},
					 ISNULL(#{interfaceYn}, 'N'),
					 CASE WHEN ISNULL(#{useYn}, 'N') = 'Y' THEN '0' ELSE '1' END,
					 #{regUserId},
					 GETDATE()
				 )
	</insert>

	<update id="ItemDAO.updateItem" parameterType="egovframework.let.basedata.item.domain.model.Item">
		UPDATE TCO403
		SET
			MATERIAL_CODE = #{itemCode},
			MATERIAL_NAME = #{itemName},
			MATERIAL_SPEC = #{specification},
			MATERIAL_FLAG = #{itemType},
			UNIT = #{unit},
			STOCK_QTY = #{stockQty},
			SAFETY_STOCK = #{safetyStock},
			PRODUCTION_PER_CYCLE = #{productionPerCycle},
			ETC = #{remark},
			INTERFACE_YN = #{interfaceYn},
			DELETE_FLAG = CASE WHEN #{useYn} = 'Y' THEN '0' ELSE '1' END,
			DELETE_DATE = CASE WHEN #{useYn} = 'Y' THEN '' ELSE GETDATE() END,
			OPMAN_CODE2 = #{updUserId},
			OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = #{factoryCode}
		    AND MATERIAL_CODE = #{itemCode}
	</update>

	<delete id="ItemDAO.deleteItem" parameterType="string">
-- 		DELETE FROM TCO403
		UPDATE TCO403
		    SET
				DELETE_FLAG = CASE WHEN #{useYn} = 'Y' THEN '0' ELSE '1' END,
				DELETE_DATE = CASE WHEN #{useYn} = 'Y' THEN '' ELSE GETDATE() END,
				OPMAN_CODE2 = 'SYSTEM',
				OPTIME2 = GETDATE()
		WHERE MATERIAL_CODE = #{itemCode}
	</delete>

	<!-- 품목 코드 중복 체크 -->
	<select id="ItemDAO.selectItemCodeCheck" parameterType="string" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TCO403
		WHERE MATERIAL_CODE = #{itemCode}
	</select>

	<!-- 품목 코드 중복 체크 (수정 시) -->
	<select id="ItemDAO.selectItemCodeCheckForUpdate" parameterType="map" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TCO403
		WHERE MATERIAL_CODE = #{itemCode}
	</select>

</mapper>
