<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProcessFlowDAO">
    <resultMap id="processFlowResult" type="egovframework.let.basedata.processFlow.domain.model.ProcessFlow">
        <result property="factoryCode" column="FACTORY_CODE"/>
        <result property="processFlowId" column="WORK_ORDER_ID"/>
        <result property="processFlowCode" column="WORK_ORDER"/>
        <result property="processFlowName" column="WORK_ORDER_NM"/>
        <result property="workplaceCode" column="WORKCENTER_CODE"/>
        <result property="workplaceName" column="WORKCENTER_NAME"/>

        <result property="deleteFlag" column="DELETE_FLAG"/>

        <result property="regUserId" column="OPMAN_CODE"/>
        <result property="regDt" column="OPTIME"/>
        <result property="updUserId" column="OPMAN_CODE2"/>
        <result property="updDt" column="OPTIME2"/>
    </resultMap>

    <!-- 검색조건에 따른 공정흐름 목록    -->
    <select id="ProcessFlowDAO.selectProcessFlowList"
            parameterType="egovframework.let.basedata.processFlow.domain.model.ProcessFlowVO"
            resultMap="processFlowResult">
        SELECT
        A.FACTORY_CODE,
        A.WORK_ORDER_ID,
        A.WORK_ORDER,
        A.WORK_ORDER_NM,
        A.WORKCENTER_CODE,
        B.WORKCENTER_NAME,
        A.USE_YN,
        A.OPTIME,
        A.OPMAN_CODE
        FROM TPR110 A
        LEFT JOIN TPR101 B
            ON A.FACTORY_CODE = B.FACTORY_CODE
            AND A.WORKCENTER_CODE = B.WORKCENTER_CODE
        WHERE 1=1
        AND A.FACTORY_CODE = #{factoryCode}
        AND ISNULL(A.DELETE_FLAG,'') != '1'
        <if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
            <choose>
                <when test="searchCnd == 0">
                    AND B.WORKCENTER_NAME LIKE '%' + #{searchWrd} + '%'
                </when>
                <when test="searchCnd == 1">
                    AND  A.WORK_ORDER_NM LIKE '%' + #{searchWrd} + '%'
                </when>
            </choose>
        </if>
        ORDER BY A.OPTIME
        <if test="firstIndex != null and recordCountPerPage != null">
            OFFSET #{firstIndex} ROWS
            FETCH NEXT #{recordCountPerPage} ROWS ONLY
        </if>
    </select>

    <!-- 검색조건에 따른 공정흐름 총 건수    -->
    <select id="ProcessFlowDAO.selectProcessFlowListCnt"
            parameterType="egovframework.let.basedata.processFlow.domain.model.ProcessFlowVO"
            resultType="int">
        SELECT COUNT(*)
        FROM TPR110 A
        LEFT JOIN TPR101 B
        ON A.FACTORY_CODE = B.FACTORY_CODE
        AND A.WORKCENTER_CODE = B.WORKCENTER_CODE
        WHERE 1=1
        AND A.FACTORY_CODE = #{factoryCode}
        AND ISNULL(A.DELETE_FLAG,'') != '1'
        <if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
            <choose>
                <when test="searchCnd == 0">
                    AND B.WORKCENTER_NAME LIKE '%' + #{searchWrd} + '%'
                </when>
                <when test="searchCnd == 1">
                    AND  A.WORK_ORDER_NM LIKE '%' + #{searchWrd} + '%'
                </when>
            </choose>
        </if>
    </select>

    <!-- 공정흐름 저장    -->
    <insert id="insertProcessFlow"
            parameterType="egovframework.let.basedata.processFlow.domain.model.ProcessFlow">
        INSERT INTO TPR110 (
            FACTORY_CODE,
            WORKCENTER_CODE,
            WORK_ORDER,
            WORK_ORDER_NM,
            DELETE_FLAG,
            OPTIME,
            OPMAN_CODE,
            WORK_ORDER_ID,
            TPR110ID
        ) VALUES (
            #{factoryCode},
            #{workplaceCode},
            #{processFlowCode},
            #{processFlowName},
            '0',
            GETDATE(),
            #{regUserId},
            #{processFlowId},
            #{processFlowId}
        )
    </insert>

    <!-- 공정흐름 수정    -->
    <update id="updateProcessFlow" parameterType="egovframework.let.basedata.processFlow.domain.model.ProcessFlowVO">
        UPDATE TPR110
        SET
            WORKCENTER_CODE = #{workplaceCode},
            WORK_ORDER = #{processFlowCode},
            WORK_ORDER_NM = #{processFlowName},
            OPMAN_CODE2 = #{updUserId},
            OPTIME2 = GETDATE()
        WHERE WORK_ORDER_ID = #{processFlowId}
    </update>

    <!-- 공정흐름 삭제    -->
    <update id="deleteProcessFlow" parameterType="string">
        UPDATE TPR110
        SET DELETE_FLAG = '1'
        WHERE WORK_ORDER_ID = #{processFlowId}
    </update>


    <!-- 공정흐름 코드 자동채번    -->
    <select id="selectProcessFlowCode" resultType="string">
        SELECT
            'PF'+
            RIGHT('0000' +
                CAST(ISNULL(MAX(CAST(RIGHT(WORK_ORDER, 4) AS INT)), 0) +1 AS VARCHAR), 4) NEXT_ID
        FROM TPR110
        WHERE WORK_ORDER LIKE 'PF%'
    </select>

    <!-- 공정흐름 TPR110ID 자동채번    -->
    <select id="selectTPR110NextId">
        SELECT
            'PF' + CONVERT(char(8), GETDATE(), 112)
                + RIGHT('0000' +
            CAST(
            ISNULL(
            MAX(CAST(RIGHT(TPR110ID, 4) AS INT)), 0
            ) + 1
            AS varchar),
            4
            ) AS NEXT_ID
        FROM TPR110
        WHERE TPR110ID LIKE  'PF' + CONVERT(char(8), GETDATE(), 112) + '%'
    </select>


    <select id="selectProcessByFlowId" parameterType="string" resultType="map">
        SELECT WORK_ORDER_ID, WORK_ORDER, WORK_CODE, WORK_SEQ
        FROM TPR110D
        WHERE WORK_ORDER_ID = #{processFlowId}
    </select>

    <select id="selectItemByFlowId" parameterType="string" resultType="map">
        SELECT WORK_ORDER_ID, PROD_CODE
        FROM TPR112
        WHERE WORK_ORDER_ID = #{processFlowId}
    </select>


</mapper>