<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EquipmentDAO">

	<resultMap id="equipmentResult" type="egovframework.let.basedata.equipment.domain.model.Equipment">
		<result property="factoryCode" column="FACTORY_CODE"/>
		<result property="equipmentId" column="EQUIPMENT_ID"/>
		<result property="equipSysCd" column="EQUIP_SYS_CD"/>
		<result property="equipCd" column="EQUIP_CD"/>
		<result property="equipmentName" column="EQUIPMENT_NAME"/>
		<result property="equipSpec" column="EQUIP_SPEC"/>
		<result property="equipStruct" column="EQUIP_KIND"/>
		<result property="plcAddress" column="PLC_ADDRESS"/>
		<result property="location" column="LOCATION"/>
		<result property="useFlag" column="USE_FLAG"/>
		<result property="statusFlag" column="STATUS_FLAG"/>
		<result property="remark" column="BIGO"/>
		<result property="managerCode" column="MANAGER1_CODE"/>
		<result property="manager2Code" column="MANAGER2_CODE"/>
		<result property="regUserId" column="OPMAN_CODE"/>
		<result property="regDt" column="OPTIME"/>
		<result property="updUserId" column="OPMAN_CODE2"/>
		<result property="updDt" column="OPTIME2"/>
	</resultMap>

	<select id="EquipmentDAO.selectEquipmentList" parameterType="egovframework.let.basedata.equipment.domain.model.EquipmentVO" resultMap="equipmentResult">
		SELECT
			FACTORY_CODE,
			EQUIP_SYS_CD AS EQUIPMENT_ID,
			EQUIP_SYS_CD,
			EQUIP_CD,
			EQUIPMENT_NAME,
			EQUIP_SPEC,
			EQUIP_KIND,
			USE_FLAG,
			MANAGER1_CODE,
			MANAGER2_CODE,
			PLC_ADDRESS,
			LOCATION,
			STATUS_FLAG,
			BIGO,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TPR151
		WHERE 1=1
		AND FACTORY_CODE = #{factoryCode}
		<if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
			<choose>
				<when test="searchCnd == '1' or searchCnd == 1">
					AND EQUIP_CD LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == '2' or searchCnd == 2">
					AND EQUIPMENT_NAME LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == '3' or searchCnd == 3">
					AND LOCATION LIKE '%' + #{searchWrd} + '%'
				</when>
			</choose>
		</if>
		<if test="statusFlag != null and statusFlag != ''">
			AND STATUS_FLAG = #{statusFlag}
		</if>
		AND USE_FLAG = 'Y'
		ORDER BY OPTIME DESC
		<if test="firstIndex != null and recordCountPerPage != null">
			OFFSET #{firstIndex} ROWS
			FETCH NEXT #{recordCountPerPage} ROWS ONLY
		</if>
	</select>

	<select id="EquipmentDAO.selectEquipmentListCnt" parameterType="egovframework.let.basedata.equipment.domain.model.EquipmentVO" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR151
		WHERE 1=1
		AND FACTORY_CODE = #{factoryCode}
		<if test="searchCnd != null and searchCnd != '' and searchWrd != null and searchWrd != ''">
			<choose>
				<when test="searchCnd == '1'">
					AND EQUIP_CD LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == '2'">
					AND EQUIPMENT_NAME LIKE '%' + #{searchWrd} + '%'
				</when>
				<when test="searchCnd == '3'">
					AND LOCATION LIKE '%' + #{searchWrd} + '%'
				</when>
			</choose>
		</if>
		<if test="statusFlag != null and statusFlag != ''">
			AND STATUS_FLAG = #{statusFlag}
		</if>
		AND USE_FLAG = 'Y'
	</select>

	<select id="EquipmentDAO.selectEquipment" parameterType="string" resultMap="equipmentResult">
		SELECT
			FACTORY_CODE,
			EQUIP_SYS_CD AS EQUIPMENT_ID,
			EQUIP_SYS_CD,
			EQUIP_CD,
			EQUIP_SPEC,
			EQUIP_KIND,
			USE_FLAG,
			MANAGER1_CODE,
			MANAGER2_CODE,
			PLC_ADDRESS,
			LOCATION,
			STATUS_FLAG,
			BIGO,
			EQUIPMENT_NAME,
			OPMAN_CODE,
			CONVERT(VARCHAR(19), OPTIME, 120) AS OPTIME,
			OPMAN_CODE2,
			CONVERT(VARCHAR(19), OPTIME2, 120) AS OPTIME2
		FROM TPR151
		WHERE EQUIP_SYS_CD = #{equipSysCd}
	</select>

	<insert id="EquipmentDAO.insertEquipment" parameterType="egovframework.let.basedata.equipment.domain.model.Equipment">
		INSERT INTO TPR151 (
			FACTORY_CODE,
			EQUIP_SYS_CD,
			EQUIP_CD,
			EQUIP_SPEC,
			EQUIP_KIND,
			USE_FLAG,
			MANAGER1_CODE,
			MANAGER2_CODE,
			PLC_ADDRESS,
			LOCATION,
			STATUS_FLAG,
			BIGO,
			EQUIPMENT_NAME,
			OPMAN_CODE,
			OPTIME
		) VALUES (
			#{factoryCode},
			#{equipSysCd},
			#{equipCd},
			#{equipSpec},
			#{equipStruct},
			ISNULL(#{useFlag}, 'Y'),
			#{managerCode},
			#{manager2Code},
			#{plcAddress},
			#{location},
			ISNULL(#{statusFlag}, '1'),
			#{remark},
			#{equipmentName},
			#{regUserId},
			GETDATE()
		)
	</insert>

	<update id="EquipmentDAO.updateEquipment" parameterType="egovframework.let.basedata.equipment.domain.model.Equipment">
		UPDATE TPR151
		SET
			EQUIP_CD = #{equipCd},
			EQUIP_SPEC = #{equipSpec},
			EQUIP_KIND = #{equipStruct},
			USE_FLAG = #{useFlag},
			MANAGER1_CODE = #{managerCode},
			MANAGER2_CODE = #{manager2Code},
			PLC_ADDRESS = #{plcAddress},
			LOCATION = #{location},
			STATUS_FLAG = #{statusFlag},
			BIGO = #{remark},
			EQUIPMENT_NAME = #{equipmentName},
			OPMAN_CODE2 = #{updUserId},
			OPTIME2 = GETDATE()
		WHERE FACTORY_CODE = #{factoryCode}
		  AND EQUIP_SYS_CD = #{equipSysCd}
	</update>

	<delete id="EquipmentDAO.deleteEquipment" parameterType="string">
-- 		DELETE FROM TPR151
		UPDATE TPR151
			SET USE_FLAG = 'N',
				OPMAN_CODE2 = 'SYSTEM',
				OPTIME2 = GETDATE()
		WHERE EQUIP_SYS_CD = #{equipSysCd}
	</delete>

	<!-- 설비 코드 중복 체크 -->
	<select id="EquipmentDAO.selectEquipmentCodeCheck" parameterType="map" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR151
		WHERE EQUIP_CD = #{equipCd}
		AND USE_FLAG = 'Y'
	</select>

	<!-- 설비 코드 중복 체크 (수정 시) -->
	<select id="EquipmentDAO.selectEquipmentCodeCheckForUpdate" parameterType="map" resultType="int">
		SELECT COUNT(*) AS CNT
		FROM TPR151
		WHERE EQUIP_CD = #{equipCd}
	</select>

</mapper>
