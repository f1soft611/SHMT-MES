# 생산계획 관리 기능 구현 가이드

## 개요

이 문서는 생산계획 관리 기능의 전면 개선 사항을 설명합니다. 작업장 선택부터 생산의뢰 멀티 선택, 거래처 정보 표시까지 전체 프로세스를 다룹니다.

## 주요 기능

### 1. 작업장 선택 기능

**목적**: 생산계획 수립 전에 작업장을 선택하여, 해당 작업장에 등록된 설비만 표시

**구현 위치**:

- `frontend/src/pages/ProductionPlan/index.tsx`

**주요 코드**:

```typescript
// 작업장 상태 관리
const [workplaces, setWorkplaces] = useState<Workplace[]>([]);
const [selectedWorkplace, setSelectedWorkplace] = useState<string>('');

// 작업장 선택 시 설비 및 작업자 로드
useEffect(() => {
  if (selectedWorkplace) {
    loadEquipmentsByWorkplace(selectedWorkplace);
    loadWorkplaceWorkers(selectedWorkplace);
  } else {
    setEquipments([]);
    setWorkplaceWorkers([]);
  }
}, [selectedWorkplace]);
```

**UI 요소**:

- 헤더 영역에 작업장 선택 드롭다운 추가
- 작업장 미선택 시 경고 메시지 표시
- 작업장 선택 필수 유효성 검증

### 2. 설비 목록 필터링

**목적**: 선택된 작업장의 공정에 연결된 설비 중, 설비연동 플래그가 'Y'인 설비만 표시

**ERD 참조**:

```
공정플래그별 (TBR110)
  → 공정등록별 (TBR112)
    → 공정등록 (TPR110D)
```

**구현**:

```typescript
const loadEquipmentsByWorkplace = async (workplaceCode: string) => {
  try {
    // 작업장별 공정 조회
    const processResponse =
      await workplaceService.getWorkplaceProcesses(workplaceCode);

    if (
      processResponse.resultCode === 200 &&
      processResponse.result?.resultList
    ) {
      // 설비연동 플래그가 'Y'인 설비만 필터링
      const filteredEquipments = processResponse.result.resultList
        .filter((process: any) => process.equipmentIntegrationYn === 'Y')
        .map((process: any) => ({
          equipCd: process.equipmentCode,
          equipmentName: process.equipmentName,
          equipmentId: process.equipmentId,
        }));

      setEquipments(filteredEquipments);
    }
  } catch (error) {
    console.error('Failed to load equipments:', error);
  }
};
```

**백엔드 요구사항**:

- `/api/workplaces/{workplaceCode}/processes` API 구현
- 공정-설비 매핑 정보 조회
- `equipmentIntegrationYn` 필드 포함

### 3. 작업자 선택 기능

**목적**: 작업장별 작업자를 선택하여 생산계획에 담당자 지정

**데이터 구조**:

```typescript
interface WorkplaceWorker {
  workplaceWorkerId?: string;
  workplaceId: string;
  workplaceCode: string;
  workerId: string;
  workerCode: string;
  workerName: string;
  position?: string;
  role?: string;
  useYn?: string;
}
```

**구현**:

```typescript
// 작업장별 작업자 로드
const loadWorkplaceWorkers = async (workplaceCode: string) => {
  try {
    const response = await workplaceService.getWorkplaceWorkers(workplaceCode);
    if (response.resultCode === 200 && response.result?.resultList) {
      setWorkplaceWorkers(response.result.resultList);
    }
  } catch (error) {
    console.error('Failed to load workplace workers:', error);
  }
};
```

**UI 요소**:

- PlanDialog 내 작업자 선택 드롭다운
- 작업자 선택 시 작업자 코드 및 이름 저장
- 향후 근무구분 자동 설정 준비

### 4. 생산의뢰 멀티 선택

**목적**: 여러 생산의뢰를 한 번에 선택하여 생산계획 수립 (단, 동일 품목만 가능)

**제약 조건**:

- 동일 품목코드만 멀티 선택 가능
- 선택된 생산의뢰들의 수량 합계를 계획수량으로 설정
- 거래처 정보 수집 및 표시

**구현**:

```typescript
const handleRowClick = (request: ProductionRequest) => {
  // Multi-selection mode with same item code restriction
  const isAlreadySelected = selectedRequests.some(
    (r) => r.orderNo === request.orderNo && r.orderSeqno === request.orderSeqno,
  );

  if (isAlreadySelected) {
    // Deselect
    setSelectedRequests(
      selectedRequests.filter(
        (r) =>
          !(
            r.orderNo === request.orderNo && r.orderSeqno === request.orderSeqno
          ),
      ),
    );
  } else {
    // Check if same item code
    if (selectedRequests.length > 0) {
      const firstItemCode = selectedRequests[0].itemCode;
      if (request.itemCode !== firstItemCode) {
        alert(`같은 품목코드(${firstItemCode})만 선택할 수 있습니다.`);
        return;
      }
    }
    setSelectedRequests([...selectedRequests, request]);
  }
};
```

**선택된 데이터 처리**:

```typescript
const handleSelectRequest = (requests: ProductionRequest[]) => {
  if (requests.length === 0) return;

  // 첫 번째 생산의뢰의 품목 정보를 기준으로 설정
  const firstRequest = requests[0];

  // 여러 생산의뢰의 수량 합계
  const totalQty = requests.reduce((sum, req) => sum + (req.orderQty || 0), 0);

  // 거래처 정보 처리
  const customerCodes = requests
    .map((r) => r.customerCode)
    .filter(Boolean) as string[];
  const customerNames = requests
    .map((r) => r.customerName)
    .filter(Boolean) as string[];
  const uniqueCustomers = Array.from(new Set(customerCodes));

  const updates = {
    itemCode: firstRequest.itemCode || '',
    itemName: firstRequest.itemName || '',
    plannedQty: totalQty,
    orderNo: firstRequest.orderNo,
    customerCode: uniqueCustomers[0],
    customerName: customerNames[0],
    additionalCustomers: uniqueCustomers.slice(1),
  };

  // 폼 데이터 업데이트
  onBatchChange(updates);
};
```

### 5. 거래처 정보 표시

**목적**: 생산계획에 거래처 정보를 표시하고, 여러 거래처가 있을 경우 상세 정보 제공

**데이터 구조**:

```typescript
interface ProductionPlanData {
  // ... 기존 필드들
  customerCode?: string;
  customerName?: string;
  additionalCustomers?: string[]; // 추가 거래처 목록
}
```

**UI 구현**:

```typescript
{/* 거래처 정보 표시 */}
{plan.customerName && (
  <Box sx={{ mt: 0.5 }}>
    <Chip
      label={
        plan.additionalCustomers && plan.additionalCustomers.length > 0
          ? `${plan.customerName} 외 ${plan.additionalCustomers.length}건`
          : plan.customerName
      }
      size="small"
      color="secondary"
      variant="outlined"
      sx={{ cursor: plan.additionalCustomers?.length ? 'pointer' : 'default' }}
      onClick={() => {
        if (plan.additionalCustomers && plan.additionalCustomers.length > 0) {
          alert(`거래처 목록:\n- ${plan.customerName}\n- ${plan.additionalCustomers.join('\n- ')}`);
        }
      }}
    />
  </Box>
)}
```

**특징**:

- 주 거래처는 항상 표시
- 추가 거래처가 있을 경우 "외 N건" 형식으로 표시
- 거래처 칩 클릭 시 전체 거래처 목록 팝업

### 6. 생산의뢰 테이블에 거래처 컬럼 추가

**TSA308 테이블 참조**:

```typescript
export interface ProductionRequest {
  // ... 기존 필드들
  customerCode?: string; // 거래처 코드
  customerName?: string; // 거래처명
}
```

**DataGrid 컬럼 추가**:

```typescript
{
  field: 'customerName',
  headerName: '거래처',
  width: 150,
  align: 'center',
  headerAlign: 'center',
  valueFormatter: (value) => value || '-',
}
```

## 데이터 흐름

### 생산계획 등록 프로세스

1. **작업장 선택**
   - 사용자가 작업장 드롭다운에서 작업장 선택
   - `selectedWorkplace` 상태 업데이트

2. **설비 및 작업자 로드**
   - `loadEquipmentsByWorkplace()` 호출
   - `loadWorkplaceWorkers()` 호출
   - 해당 작업장의 설비 및 작업자 목록 표시

3. **계획 추가 버튼 클릭**
   - 선택된 작업장, 설비 정보를 기본값으로 설정
   - PlanDialog 오픈

4. **생산의뢰 선택 (선택사항)**
   - ProductionRequestDialog 오픈
   - 멀티 선택 가능 (동일 품목 제약)
   - 선택 확정 시 품목, 수량, 거래처 정보 자동 입력

5. **작업자 선택**
   - 작업장별 작업자 목록에서 선택
   - 작업자 정보 저장

6. **저장**
   - 유효성 검증
   - 생산계획 데이터 생성
   - 캘린더에 표시

## 향후 구현 예정

### 1. 품목 직접 선택 기능

- 생산의뢰 없이 품목을 직접 선택하여 계획 수립
- 품목 검색 다이얼로그 구현

### 2. 데이터베이스 저장

**테이블 구조**:

- **TPR301M** (생산계획마스터)
  - 생산계획 기본 정보
- **TPR301** (생산계획)
  - 생산계획 상세 정보
- **TPR301R** (생산계획상세)
  - 생산의뢰 연동 정보

**트랜잭션 처리**:

```
BEGIN TRANSACTION
  INSERT INTO TPR301M (...)
  INSERT INTO TPR301 (...)
  INSERT INTO TPR301R (...) -- 생산의뢰가 있을 경우
COMMIT
```

### 3. 근무구분 자동 설정

- 작업자 정보에 근무구분 추가 (주야, ABC 교대)
- 작업자 선택 시 자동으로 근무구분 설정

## API 명세

### 필요한 백엔드 API

1. **작업장별 공정-설비 조회**

   ```
   GET /api/workplaces/{workplaceCode}/processes
   Response: {
     resultCode: 200,
     result: {
       resultList: [
         {
           processCode: string,
           processName: string,
           equipmentCode: string,
           equipmentName: string,
           equipmentIntegrationYn: 'Y' | 'N'
         }
       ]
     }
   }
   ```

2. **작업장별 작업자 조회**

   ```
   GET /api/workplaces/{workplaceCode}/workers
   Response: {
     resultCode: 200,
     result: {
       resultList: [
         {
           workerCode: string,
           workerName: string,
           position: string,
           shift: string  // 근무구분 (향후 추가)
         }
       ]
     }
   }
   ```

3. **생산의뢰 조회 (거래처 포함)**

   ```
   GET /api/production-requests
   Response: {
     resultCode: 200,
     result: {
       resultList: [
         {
           orderNo: string,
           orderSeqno: number,
           itemCode: string,
           itemName: string,
           orderQty: number,
           customerCode: string,
           customerName: string
         }
       ]
     }
   }
   ```

4. **생산계획 저장**
   ```
   POST /api/production-plans
   Request: {
     workplaceCode: string,
     equipmentCode: string,
     workerCode: string,
     planDate: string,
     itemCode: string,
     plannedQty: number,
     shift: 'DAY' | 'NIGHT',
     customerCode: string,
     productionRequests: [  // 생산의뢰 연동 정보
       {
         orderNo: string,
         orderSeqno: number,
         orderHistno: number
       }
     ]
   }
   Response: {
     resultCode: 200,
     result: {
       planId: string
     }
   }
   ```

## 테스트 시나리오

### 1. 작업장 선택 테스트

1. 생산계획 화면 진입
2. 작업장 선택 전 "계획 추가" 버튼 클릭
   - 예상: 경고 메시지 표시
3. 작업장 선택
   - 예상: 해당 작업장의 설비 목록 표시

### 2. 생산의뢰 멀티 선택 테스트

1. "계획 추가" 버튼 클릭
2. "생산의뢰 선택" 버튼 클릭
3. 첫 번째 생산의뢰 선택 (품목코드: A)
4. 두 번째 생산의뢰 선택 (품목코드: A)
   - 예상: 정상 선택
5. 세 번째 생산의뢰 선택 (품목코드: B)
   - 예상: 경고 메시지 및 선택 불가

### 3. 거래처 정보 표시 테스트

1. 여러 거래처를 가진 생산의뢰 멀티 선택
2. "선택" 버튼 클릭
3. 등록 폼에서 거래처 정보 확인
   - 예상: "거래처1 외 2건" 형식으로 표시
4. 저장 후 캘린더에서 거래처 칩 클릭
   - 예상: 전체 거래처 목록 팝업

## 트러블슈팅

### 문제: 작업장 선택 후 설비가 표시되지 않음

**원인**:

- 백엔드 API가 구현되지 않음
- `equipmentIntegrationYn` 필드가 누락됨

**해결**:

- Mock 데이터로 테스트
- 백엔드 API 구현 확인

### 문제: 생산의뢰 멀티 선택 시 수량이 합산되지 않음

**원인**:

- `reduce` 함수의 초기값 누락

**해결**:

```typescript
const totalQty = requests.reduce((sum, req) => sum + (req.orderQty || 0), 0);
```

## 변경 이력

- **2024-11-20**: 초기 구현
  - 작업장 선택 기능
  - 설비 필터링
  - 작업자 선택
  - 생산의뢰 멀티 선택
  - 거래처 정보 표시
